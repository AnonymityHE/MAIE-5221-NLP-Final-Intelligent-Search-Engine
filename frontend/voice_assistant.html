<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis è¯­éŸ³åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.disconnected {
            background: #fee;
            color: #c33;
        }
        
        .status.connected {
            background: #efe;
            color: #3c3;
        }
        
        .status.recording {
            background: #ffe;
            color: #c93;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-record {
            background: #ff4757;
            color: white;
        }
        
        .btn-record:hover {
            background: #ff3838;
        }
        
        .btn-record:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-stop {
            background: #2ed573;
            color: white;
        }
        
        .btn-stop:hover {
            background: #26d66f;
        }
        
        .btn-connect {
            background: #667eea;
            color: white;
        }
        
        .btn-disconnect {
            background: #999;
            color: white;
        }
        
        .transcript {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
        }
        
        .transcript-item {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 4px solid #667eea;
            background: white;
            border-radius: 5px;
        }
        
        .transcript-item.user {
            border-left-color: #2ed573;
        }
        
        .transcript-item.jarvis {
            border-left-color: #ff4757;
        }
        
        .label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .text {
            color: #333;
            line-height: 1.6;
        }
        
        .wake-word-hint {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ Jarvis è¯­éŸ³åŠ©æ‰‹</h1>
        <p class="subtitle">è¯´ "Jarvis" å”¤é†’åŠ©æ‰‹ï¼Œç„¶åæé—®</p>
        
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        
        <div class="controls">
            <button id="btnConnect" class="btn-connect" onclick="connect()">è¿æ¥</button>
            <button id="btnRecord" class="btn-record" onclick="startRecording()" disabled>å¼€å§‹å½•éŸ³</button>
            <button id="btnStop" class="btn-stop" onclick="stopRecording()" disabled>åœæ­¢å½•éŸ³</button>
            <button id="btnDisconnect" class="btn-disconnect" onclick="disconnect()" disabled>æ–­å¼€</button>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div class="transcript" id="transcript"></div>
        
        <div class="wake-word-hint">
            ğŸ’¡ æç¤ºï¼šè¯´ "Jarvis, [ä½ çš„é—®é¢˜]" æ¥å”¤é†’åŠ©æ‰‹<br>
            ä¾‹å¦‚ï¼š"Jarvis, ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"<br>
            <small>âœ¨ å·²å¯ç”¨VADè‡ªåŠ¨æ£€æµ‹ï¼šè¯´è¯ç»“æŸå2ç§’è‡ªåŠ¨åœæ­¢å½•éŸ³</small>
        </div>
    </div>
    
    <script>
        let ws = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let vadCheckInterval = null;
        let silenceStartTime = null;
        const API_BASE = window.location.origin.replace('http://', 'ws://').replace('https://', 'wss://');
        
        // VADé…ç½®
        const VAD_CONFIG = {
            threshold: 0.02,  // éŸ³é‡é˜ˆå€¼ï¼ˆ0-1ï¼‰
            minSpeechDuration: 500,  // æœ€å°è¯­éŸ³æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            maxSilenceDuration: 2000,  // æœ€å¤§é™éŸ³æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œè¶…è¿‡æ­¤æ—¶é—´è‡ªåŠ¨åœæ­¢
            checkInterval: 100  // æ£€æµ‹é—´éš”ï¼ˆæ¯«ç§’ï¼‰
        };
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            console.error('é”™è¯¯:', message);
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function updateStatus(status, text) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = text;
        }
        
        function addTranscript(type, label, text, isStreaming = false) {
            const transcriptDiv = document.getElementById('transcript');
            const item = document.createElement('div');
            item.className = `transcript-item ${type} ${isStreaming ? 'streaming' : ''}`;
            item.innerHTML = `
                <div class="label">${label}${isStreaming ? ' <span style="color: #667eea;">[å®æ—¶]</span>' : ''}</div>
                <div class="text">${text}</div>
            `;
            transcriptDiv.appendChild(item);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
            return item;  // è¿”å›å…ƒç´ å¼•ç”¨ï¼Œç”¨äºæµå¼æ›´æ–°
        }
        
        async function connect() {
            try {
                ws = new WebSocket(`${API_BASE}/api/voice/ws`);
                
                ws.onopen = () => {
                    updateStatus('connected', 'å·²è¿æ¥');
                    document.getElementById('btnConnect').disabled = true;
                    document.getElementById('btnDisconnect').disabled = false;
                    document.getElementById('btnRecord').disabled = false;
                };
                
                // ç”¨äºå­˜å‚¨æµå¼è½¬å½•å’ŒTTSçš„ä¸´æ—¶æ•°æ®
                let currentTranscriptionItem = null;
                let currentTTSItem = null;
                let audioChunks = [];
                let audioContext = null;
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', data); // è°ƒè¯•ä¿¡æ¯
                        
                        if (data.type === 'connected') {
                            addTranscript('system', 'ç³»ç»Ÿ', `å·²è¿æ¥åˆ°Jarvisï¼ˆå”¤é†’è¯: ${data.wake_word}ï¼‰`);
                        } else if (data.type === 'transcription_partial') {
                            // æµå¼STTï¼šå®æ—¶æ˜¾ç¤ºè½¬å½•ç»“æœ
                            if (!currentTranscriptionItem) {
                                currentTranscriptionItem = addTranscript('user', 'å®æ—¶è½¬å½•', '', true);
                            }
                            const textDiv = currentTranscriptionItem.querySelector('.text');
                            textDiv.textContent = data.text;
                            console.log('å®æ—¶è½¬å½•:', data.text);
                        } else if (data.type === 'audio_chunk') {
                            // æµå¼TTSï¼šæ¥æ”¶éŸ³é¢‘å—å¹¶æ’­æ”¾
                            if (!currentTTSItem) {
                                currentTTSItem = addTranscript('jarvis', 'Jarviså›ç­”ï¼ˆæµå¼ï¼‰', 'æ­£åœ¨ç”Ÿæˆè¯­éŸ³...', true);
                            }
                            
                            // è§£ç base64éŸ³é¢‘
                            const audioData = atob(data.audio);
                            const audioArray = new Uint8Array(audioData.length);
                            for (let i = 0; i < audioData.length; i++) {
                                audioArray[i] = audioData.charCodeAt(i);
                            }
                            audioChunks.push(audioArray);
                            
                            // å®æ—¶æ’­æ”¾éŸ³é¢‘å—ï¼ˆå¦‚æœå·²æ”¶é›†è¶³å¤Ÿæ•°æ®ï¼‰
                            if (audioChunks.length >= 3) {  // æ¯3ä¸ªå—æ’­æ”¾ä¸€æ¬¡
                                playAudioChunks();
                                audioChunks = [];
                            }
                        } else if (data.type === 'audio_complete') {
                            // TTSå®Œæˆï¼šæ’­æ”¾å‰©ä½™çš„éŸ³é¢‘å—
                            if (audioChunks.length > 0) {
                                playAudioChunks();
                                audioChunks = [];
                            }
                            if (currentTTSItem) {
                                const textDiv = currentTTSItem.querySelector('.text');
                                textDiv.textContent = 'è¯­éŸ³æ’­æ”¾å®Œæˆ';
                                currentTTSItem = null;
                            }
                            console.log('æµå¼TTSå®Œæˆ');
                        } else if (data.type === 'response') {
                            // é‡ç½®æµå¼çŠ¶æ€
                            currentTranscriptionItem = null;
                            currentTTSItem = null;
                            
                            if (data.transcribed_text) {
                                addTranscript('user', 'ä½ è¯´', data.transcribed_text);
                                console.log('è½¬å½•æ–‡æœ¬:', data.transcribed_text);
                            }
                            
                            if (data.wake_word_detected) {
                                const queryDisplay = data.query_text || '(æŸ¥è¯¢æ–‡æœ¬ä¸ºç©º)';
                                addTranscript('jarvis', 'Jarvis', `æ£€æµ‹åˆ°å”¤é†’è¯ï¼ŒæŸ¥è¯¢: "${queryDisplay}"`);
                                console.log('å”¤é†’è¯æ£€æµ‹:', true, 'æŸ¥è¯¢æ–‡æœ¬:', queryDisplay);
                            } else {
                                console.log('æœªæ£€æµ‹åˆ°å”¤é†’è¯');
                            }
                            
                            // å¦‚æœå¯ç”¨äº†æµå¼TTSï¼Œç­”æ¡ˆä¼šé€šè¿‡audio_chunkå‘é€
                            if (data.streaming_tts) {
                                addTranscript('jarvis', 'Jarvis', 'æ­£åœ¨ç”Ÿæˆæµå¼è¯­éŸ³å›ç­”...');
                                console.log('å¯ç”¨æµå¼TTSï¼Œç­‰å¾…éŸ³é¢‘å—...');
                            } else if (data.answer && data.answer.trim() !== '') {
                                addTranscript('jarvis', 'Jarviså›ç­”', data.answer);
                                console.log('æ”¶åˆ°å›ç­”:', data.answer.substring(0, 100) + '...');
                            } else if (data.query_text) {
                                // å¦‚æœæœ‰æŸ¥è¯¢ä½†æ²¡æœ‰ç­”æ¡ˆï¼Œæ˜¾ç¤ºå¤„ç†ä¸­
                                addTranscript('jarvis', 'Jarvis', 'æ­£åœ¨å¤„ç†æŸ¥è¯¢ï¼Œè¯·ç¨å€™...');
                                console.log('æŸ¥è¯¢å·²å‘é€ï¼Œç­‰å¾…å›ç­”...');
                            } else {
                                console.warn('æ”¶åˆ°å“åº”ä½†æ²¡æœ‰æŸ¥è¯¢æ–‡æœ¬å’Œç­”æ¡ˆ');
                            }
                            
                            // æ˜¾ç¤ºå·¥å…·ä½¿ç”¨æƒ…å†µ
                            if (data.tools_used && data.tools_used.length > 0) {
                                addTranscript('system', 'ç³»ç»Ÿ', `ä½¿ç”¨çš„å·¥å…·: ${data.tools_used.join(', ')}`);
                                console.log('ä½¿ç”¨çš„å·¥å…·:', data.tools_used);
                            }
                        } else if (data.type === 'error' || data.type === 'transcription_error') {
                            const errorMsg = data.message || data.error || 'æœªçŸ¥é”™è¯¯';
                            showError(errorMsg);
                            addTranscript('system', 'é”™è¯¯', errorMsg);
                            console.error('æœåŠ¡å™¨é”™è¯¯:', errorMsg);
                        } else {
                            console.warn('æœªçŸ¥çš„æ¶ˆæ¯ç±»å‹:', data.type);
                        }
                    } catch (e) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e, event.data);
                        showError('è§£ææœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥');
                    }
                };
                
                // æ’­æ”¾éŸ³é¢‘å—çš„å‡½æ•°
                function playAudioChunks() {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    try {
                        // åˆå¹¶æ‰€æœ‰éŸ³é¢‘å—
                        const totalLength = audioChunks.reduce((sum, chunk) => sum + chunk.length, 0);
                        const mergedArray = new Uint8Array(totalLength);
                        let offset = 0;
                        for (const chunk of audioChunks) {
                            mergedArray.set(chunk, offset);
                            offset += chunk.length;
                        }
                        
                        // è§£ç å¹¶æ’­æ”¾
                        audioContext.decodeAudioData(mergedArray.buffer.slice(0))
                            .then(audioBuffer => {
                                const source = audioContext.createBufferSource();
                                source.buffer = audioBuffer;
                                source.connect(audioContext.destination);
                                source.start();
                            })
                            .catch(err => {
                                console.warn('éŸ³é¢‘è§£ç å¤±è´¥:', err);
                            });
                    } catch (err) {
                        console.warn('æ’­æ”¾éŸ³é¢‘å—å¤±è´¥:', err);
                    }
                }
                
                ws.onerror = (error) => {
                    showError('WebSocketè¿æ¥é”™è¯¯');
                    console.error(error);
                };
                
                ws.onclose = () => {
                    updateStatus('disconnected', 'å·²æ–­å¼€');
                    document.getElementById('btnConnect').disabled = false;
                    document.getElementById('btnDisconnect').disabled = true;
                    document.getElementById('btnRecord').disabled = true;
                    document.getElementById('btnStop').disabled = true;
                };
                
            } catch (error) {
                showError('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                silenceStartTime = null;
                
                // è®¾ç½®Web Audio APIç”¨äºVADæ£€æµ‹
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                let speechStartTime = null;
                
                // VADæ£€æµ‹å‡½æ•°
                function checkVoiceActivity() {
                    if (!isRecording) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const normalizedVolume = average / 255;
                    
                    // æ£€æµ‹åˆ°è¯­éŸ³
                    if (normalizedVolume > VAD_CONFIG.threshold) {
                        if (speechStartTime === null) {
                            speechStartTime = Date.now();
                        }
                        silenceStartTime = null;
                        updateStatus('recording', 'æ­£åœ¨å½•éŸ³... (æ£€æµ‹åˆ°è¯­éŸ³)');
                    } else {
                        // æ£€æµ‹åˆ°é™éŸ³
                        if (speechStartTime !== null) {
                            // å·²ç»è¯´è¿‡è¯ï¼Œå¼€å§‹è®¡æ—¶é™éŸ³
                            if (silenceStartTime === null) {
                                silenceStartTime = Date.now();
                            }
                            
                            const silenceDuration = Date.now() - silenceStartTime;
                            const speechDuration = silenceStartTime - speechStartTime;
                            
                            // å¦‚æœå·²ç»è¯´è¿‡è¯ä¸”é™éŸ³æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼Œè‡ªåŠ¨åœæ­¢
                            if (speechDuration >= VAD_CONFIG.minSpeechDuration && 
                                silenceDuration >= VAD_CONFIG.maxSilenceDuration) {
                                console.log('VADæ£€æµ‹åˆ°é™éŸ³ï¼Œè‡ªåŠ¨åœæ­¢å½•éŸ³');
                                stopRecording();
                                return;
                            }
                            
                            updateStatus('recording', `æ­£åœ¨å½•éŸ³... (é™éŸ³ ${Math.round(silenceDuration/1000)}s)`);
                        }
                    }
                }
                
                // å¼€å§‹VADæ£€æµ‹
                vadCheckInterval = setInterval(checkVoiceActivity, VAD_CONFIG.checkInterval);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    // åœæ­¢VADæ£€æµ‹
                    if (vadCheckInterval) {
                        clearInterval(vadCheckInterval);
                        vadCheckInterval = null;
                    }
                    
                    // æ¸…ç†Web Audio API
                    if (microphone) {
                        microphone.disconnect();
                        microphone = null;
                    }
                    if (analyser) {
                        analyser.disconnect();
                        analyser = null;
                    }
                    if (audioContext && audioContext.state !== 'closed') {
                        await audioContext.close();
                        audioContext = null;
                    }
                    
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log('å½•éŸ³åœæ­¢ï¼ŒéŸ³é¢‘å¤§å°:', audioBlob.size, 'bytes');
                    
                    if (audioBlob.size === 0) {
                        showError('å½•éŸ³ä¸ºç©ºï¼Œè¯·é‡æ–°å½•éŸ³');
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            console.log('å‘é€éŸ³é¢‘æ•°æ®ï¼Œbase64é•¿åº¦:', base64Audio.length, 'bytes'); // è°ƒè¯•ä¿¡æ¯
                            try {
                                ws.send(JSON.stringify({
                                    type: 'audio',
                                    data: base64Audio,
                                    format: 'webm',
                                    is_final: true
                                }));
                                console.log('éŸ³é¢‘æ•°æ®å·²å‘é€');
                            } catch (e) {
                                console.error('å‘é€éŸ³é¢‘æ•°æ®å¤±è´¥:', e);
                                showError('å‘é€éŸ³é¢‘æ•°æ®å¤±è´¥: ' + e.message);
                            }
                        } else {
                            const state = ws ? ws.readyState : 'null';
                            console.error('WebSocketæœªè¿æ¥ï¼ŒçŠ¶æ€:', state);
                            showError('WebSocketæœªè¿æ¥ï¼Œè¯·å…ˆç‚¹å‡»"è¿æ¥"');
                        }
                    };
                    
                    reader.onerror = (e) => {
                        console.error('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥:', e);
                        showError('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥');
                    };
                    
                    reader.readAsDataURL(audioBlob);
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                updateStatus('recording', 'æ­£åœ¨å½•éŸ³... (ç­‰å¾…è¯­éŸ³)');
                document.getElementById('btnRecord').disabled = true;
                document.getElementById('btnStop').disabled = false;
                
            } catch (error) {
                showError('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                // åœæ­¢VADæ£€æµ‹
                if (vadCheckInterval) {
                    clearInterval(vadCheckInterval);
                    vadCheckInterval = null;
                }
                
                mediaRecorder.stop();
                isRecording = false;
                updateStatus('connected', 'å·²è¿æ¥');
                document.getElementById('btnRecord').disabled = false;
                document.getElementById('btnStop').disabled = true;
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            disconnect();
        });
    </script>
</body>
</html>

